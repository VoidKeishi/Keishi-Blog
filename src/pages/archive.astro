---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import { topics, type Topic } from '../content/config';
import { formatDateShort } from '../lib/utils';

// Get all published posts
const allPosts = await getCollection('posts', ({ data }) => !data.draft);

// Sort by date (newest first)
const sortedPosts = allPosts.sort(
  (a, b) => b.data.date.getTime() - a.data.date.getTime()
);

// Group posts by year
const postsByYear = sortedPosts.reduce((acc, post) => {
  const year = post.data.date.getFullYear().toString();
  if (!acc[year]) acc[year] = [];
  acc[year].push(post);
  return acc;
}, {} as Record<string, typeof sortedPosts>);

// Get years in descending order
const years = Object.keys(postsByYear).sort((a, b) => parseInt(b) - parseInt(a));
---

<BaseLayout 
  title="Archive" 
  description="A chronological list of all essays on technology, systems thinking, and life."
>
  <div class="archive-page">
    <section class="page-header">
      <div class="container">
        <h1 class="page-title">Archive</h1>
        <p class="page-description">
          All {sortedPosts.length} essays, organized by year.
        </p>
      </div>
    </section>

    <section class="archive-section">
      <div class="container">
        {sortedPosts.length > 0 ? (
          <div class="archive-list">
            {years.map(year => (
              <div class="year-group">
                <h2 class="year-title">{year}</h2>
                <ul class="posts-list">
                  {postsByYear[year].map(post => (
                    <li class="post-item">
                      <a href={`/posts/${post.slug}`} class="post-link">
                        <span class="post-indicator">â–¸</span>
                        <span class="post-title">{post.data.title}</span>
                        <span class="post-meta">
                          <span class="badge">{topics[post.data.topic].name}</span>
                          <span class="post-date">{formatDateShort(post.data.date)}</span>
                        </span>
                      </a>
                    </li>
                  ))}
                </ul>
              </div>
            ))}
          </div>
        ) : (
          <p class="empty-state">
            No essays published yet. Check back soon!
          </p>
        )}
      </div>
    </section>
  </div>
</BaseLayout>

<style>
  .archive-page {
    padding-bottom: 4rem;
  }

  .page-header {
    padding: 4rem 0 3rem;
    border-bottom: 1px solid var(--border);
  }

  .page-title {
    font-size: clamp(2rem, 4vw, 3rem);
    margin-bottom: 0.75rem;
  }

  .page-description {
    font-size: 1.125rem;
    color: var(--text-secondary);
    margin: 0;
  }

  .archive-section {
    padding: 3rem 0;
  }

  .archive-list {
    display: flex;
    flex-direction: column;
    gap: 3rem;
  }

  .year-group {
    display: flex;
    flex-direction: column;
    gap: 0;
  }

  .year-title {
    font-family: var(--font-heading);
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0 0 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--accent);
    display: inline-block;
  }

  .posts-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .post-item {
    border-bottom: 1px solid var(--border);
  }

  .post-item:last-child {
    border-bottom: none;
  }

  .post-link {
    display: flex;
    align-items: baseline;
    gap: 0.75rem;
    padding: 0.875rem 0;
    text-decoration: none;
    transition: background-color var(--transition-fast);
  }

  .post-item:hover .post-link {
    padding-left: 0.75rem;
    margin-left: -0.75rem;
    padding-right: 0.75rem;
    margin-right: -0.75rem;
    background-color: var(--bg-secondary);
  }

  .post-indicator {
    color: var(--accent);
    font-size: 0.875rem;
    flex-shrink: 0;
  }

  .post-title {
    font-family: var(--font-body);
    font-size: 1rem;
    color: var(--text-primary);
    flex: 1;
    min-width: 0;
    transition: color var(--transition-fast);
  }

  .post-item:hover .post-title {
    color: var(--accent);
  }

  .post-meta {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-shrink: 0;
  }

  .post-date {
    font-family: var(--font-ui);
    font-size: 0.8rem;
    color: var(--text-muted);
    white-space: nowrap;
  }

  .empty-state {
    color: var(--text-muted);
    font-style: italic;
    text-align: center;
    padding: 3rem;
  }

  /* Responsive */
  @media (max-width: 640px) {
    .post-link {
      flex-wrap: wrap;
    }

    .post-meta {
      width: 100%;
      padding-left: 1.5rem;
      margin-top: 0.25rem;
    }
  }
</style>

